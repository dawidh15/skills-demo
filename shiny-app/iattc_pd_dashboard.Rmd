---
title: "IATTC Public Domain Data"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: 
      bootswatch: united
    logo: logo.png
    favicon: logo.png
---

# Page 1 {data-orientation=rows}

```{r setup, include=FALSE, context = "server"}
library(flexdashboard)
library(shiny)
library(skillsTools) #loads tidyverse, fs, RSQlite
library(dygraphs)
# library(leaflet)
# bslib::bs_themer() # Activates Theme selection tool
# thematic::thematic_rmd() # set ggplot in theme colors

# ------------CACHE----------------
# Store cache on disk, is persistent across R processes
# Otherwise, cache is stored in memory
# See https://shiny.rstudio.com/articles/caching.html
#shinyOptions(cache = cachem::cache_disk(file.path(dirname(tempdir()), "myapp-cache")))
shinyOptions(cache = cachem::cache_disk(path_join(c(".","appCache"))))

dat_sp_catch_by_spp <- GetTable(".", "General Spatial Data")
dat_spp_time <- GetTable(".", "Catch Time Series")
dat_prop_ctch <- GetTable(table_name = "Proportional Catches by Period-Flag")

```

## Column {.sidebar data-width=200}

```{r}
selectInput("selectedSpp"
            , label = "Select a species"
            , choices = skillsTools::GetSppNames(".")
            , multiple = FALSE
            , selected = "ALL")

actionButton("submitP1", label = "Apply", icon = icon("filter"))
```


## Row  {data-height=300}

### Instructions

- Hola
- Mundo

### Historical catches by species

```{r}
# Get spp from input when Apply button is pressed
# add ignoreNULL = FALSE, this allows to use the default selected value for the input
#this_spp <- eventReactive(input$submitP1, valueExpr = input$selectedSpp,ignoreNULL = FALSE)

```


```{r}
fillCol(
  plotOutput( "HistoricalCatchMap", height = "100%" )
)
output$HistoricalCatchMap <- 
  renderPlot( MapCatchesBySpp(filter(dat_sp_catch_by_spp, Species == input$selectedSpp ))) %>% 
  bindCache(input$selectedSpp) %>% 
  bindEvent(input$submitP1, ignoreNULL = FALSE)
```

## Row {data-height=150}
### Time series

```{r}
fillCol(
 dygraphOutput("CatchTimeSeries", height = "100%") 
)

output$CatchTimeSeries <- 
  renderDygraph({
    # browser()
    plot_dat_spp_time <-
      dat_spp_time %>%
      filter(Species == input$selectedSpp) %>%
      select(-Species)
    dygraph(plot_dat_spp_time) %>% dyRangeSelector()
  }) %>% 
  bindCache(input$selectedSpp) %>% 
  bindEvent(input$submitP1, ignoreNULL = FALSE)
```

# Flag {data-orientation=rows}

## Input {.sidebar data-width=200}

```{r}
defaultFlag <- pull(skillsTools::GetFlagNames("."), Flag) %>% first()

selectInput("selectedFlag"
            , label = "Select a Flag"
            , choices = skillsTools::GetFlagNames(".")
            , multiple = FALSE
            ,selected = defaultFlag)
periods <- skillsTools::GetTimePeriod(".")


sliderInput(
  "sliderPeriod",
  "Select a time period",
  value = max(periods),
  min = min(periods),
  max = max(periods),
  step = 1L
)
 
actionButton("submitP2", label = "Apply", icon = icon("filter"))
```


```{r}
ScaledCatchesData <- 
  reactive({
    dat_prop_ctch %>% 
      filter(Period == input$sliderPeriod & Flag == input$selectedFlag)
  }) %>% 
  bindEvent(input$submitP2, ignoreNULL = FALSE)

ranks <- reactive({ 
  dat_prop_ctch %>% 
    filter(Period == input$sliderPeriod) %>%
    pull(Ranking) %>%
    max(na.rm = TRUE)
  }) %>% 
  bindEvent(input$submitP2, ignoreNULL = FALSE)

thisRanking <- reactive({ 
  dat_prop_ctch %>% 
    filter(Period == input$sliderPeriod & Flag == input$selectedFlag) %>%
    pull(Ranking) %>%
    min(na.rm = TRUE)
  }) %>% 
  bindEvent(input$submitP2, ignoreNULL = FALSE)

maxCatch <- 
  reactive({ 
  dat_prop_ctch %>% 
    filter(Period == input$sliderPeriod) %>%
    pull(Weight) %>%
    max(na.rm = TRUE) %>%
    formatC(big.mark = " ",format = "f", digits = 0)
  })  %>% 
  bindEvent(input$submitP2, ignoreNULL = FALSE)

```


## Row


### Chart A

```{r}
    valueBoxOutput("ThisRanks")

output$ThisRanks <- renderValueBox(
  flexdashboard::valueBox(maxCatch(), caption = "Max Catch by species (mt), during this period")
)
```


### Chart B

```{r}
gaugeOutput("FlagRank")


output$FlagRank <-
  renderGauge(
    gauge(
    round(100 * (ranks() / thisRanking()) / ranks(), digits = 0),
    min = 0,
    max = 100,
    #symbol ='%',
    sectors = gaugeSectors(
      success = c(0,25),
      warning = c(26,75),
      danger = c(76,100),
      colors = c("blue", "yellow", "red")
    )
    , label = "Fishing Pressure"
  )
)

# 
# output$FlagRank <- 
#   renderGauge(
#     gauge(
#     ranks(),
#     min = 1,
#     max = 100
#     ,
#     sectors = gaugeSectors(
#       success = c(1,20),
#       warning = c(21,40),
#       danger = c(40,69),
#       colors = c("green", "yellow", "red")
#     )
#   )
# )

```

## Scaled Catches

```{r}

fillCol(plotOutput("ScaledCatches"))
output$ScaledCatches <- 
  renderPlot(PlotByFlag(ScaledCatchesData()))
```




# Page 2 {data-orientation=rows data-navmenu="Menu B"}

## A new row


### Articles per Day

```{r}
articles <- 3
valueBox(articles, icon = "fa-pencil")
```

### Comments per Day

```{r}
comments <- 736
valueBox(comments, icon = "fa-comments")
```

### Spam per Day

```{r}
spam <- formatC(23456789,big.mark = " ",format = "f", digits = 0) 
valueBox(spam, 
         icon = "fa-trash",
         color = ifelse(spam > 10, "warning", "primary"),caption = "Spam")
```


## Row {.tabset .tabset-fade}


### Tips

No separar por comas los argumentos para cada Pagina, colunma/fila, o cuadro

### Layout

Incluye varios temas. Ver los temas dispobibles [aqu√≠](https://pkgs.rstudio.com/flexdashboard/articles/using.html#appearance).
Otros temas pueden romper los widgets.




# Page 3 {data-orientation=rows data-navmenu="Menu B"}

## Row {data-height=2}

### Chart D
```{r}
plot(1,1)
```

## second row page 3 {data-height=1}


### Chart E {data-width=3}

```{r}
plot(1,1)
```

### Chart F {data-width=1}

```{r}
plot(1,1)
```
